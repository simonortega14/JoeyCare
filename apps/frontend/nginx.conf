server {
  listen 80;
  server_name _;

  # ===========================
  # FRONTEND ESTÁTICO
  # ===========================
  root /usr/share/nginx/html;
  index index.html;

  #################################################################
  # MICROSERVICIO: USUARIOS
  #
  # Front llama:
  #   /api/usuarios/auth/login
  #
  # ms-usuarios realmente expone:
  #   http://ms-usuarios:3001/api/usuarios/auth/login
  #
  # Así que necesitamos INCLUIR /api/usuarios/ en el proxy_pass.
  #################################################################
  location /api/usuarios/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-usuarios:3001/api/usuarios/;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
  }

  #################################################################
  # MICROSERVICIO: ECOGRAFÍAS
  #
  # Front llama:
  #   /api/ecografias?neonato_id=...&page=...
  #
  # ¿Cómo está el backend?
  # Antes tú mismo dijiste:
  #   "internamente queremos hablar con ms-ecografias en:
  #    http://ms-ecografias:3002/api/ecografias/"
  #
  # Eso quiere decir que ms-ecografias EXPONE /api/ecografias (no / a pelo).
  #
  # Entonces debemos comportarnos EXACTO igual que con usuarios
  # (mantener /api/ecografias/ en el proxy_pass),
  # PERO eliminar las redirecciones 308 que estaban rompiendo el header.
  #################################################################
  location /api/ecografias/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-ecografias:3002/api/ecografias/;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;

    client_max_body_size 200m;
    client_body_buffer_size 64m;
  }

  #################################################################
  # MICROSERVICIO: VISUALIZADOR (namespace amigable)
  #
  # 1) Lista neonatos:
  #   Front: GET /api/visualizador/neonatos
  #   Destino real:
  #       ms-usuarios:3001/api/usuarios/neonatos
  #
  # Esta ruta en ms-usuarios ya incluye /api/usuarios/..., entonces
  # podemos apuntar directo.
  #################################################################
  location /api/visualizador/neonatos/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-usuarios:3001/api/usuarios/neonatos;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
  }

  #################################################################
  # 2) Ecografías de un neonato específico (REST futuro)
  #
  # Front (futuro): GET /api/visualizador/neonatos/:id/ecografias
  # Queremos:       ms-ecografias:3002/api/neonatos/:id/ecografias
  #################################################################
  location ~ ^/api/visualizador/neonatos/([^/]+)/ecografias/?$ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-ecografias:3002/api/neonatos/$1/ecografias;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
  }

  #################################################################
  # 3) Descarga/uploads de archivos DICOM
  #
  # Front: GET /api/visualizador/uploads/<file>
  # Destino: ms-ecografias:3002/api/uploads/<file>
  #
  # Aquí sí es correcto mantener el sufijo completo.
  #################################################################
  location /api/visualizador/uploads/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-ecografias:3002/api/uploads/;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;

    client_max_body_size 200m;
    client_body_buffer_size 64m;
  }

  #################################################################
  # 4) Analysis / anotaciones clínicas
  #
  # Front:  POST /api/visualizador/analysis/...
  # Destino: ms-visualizador:3003/api/visualizador/analysis/...
  #################################################################
  location /api/visualizador/analysis/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-visualizador:3003/api/visualizador/analysis/;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
  }

  #################################################################
  # MICROSERVICIO: REPORTES
  #
  # Front: /api/reportes/...
  # ms-reportes escucha raíz (ej: http://ms-reportes:3004/*)
  # Si en tu backend de reportes las rutas YA incluyen /api/reportes/,
  # entonces ajústalo igual que usuarios/ecografias.
  #################################################################
  location /api/reportes/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://ms-reportes:3004/;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
  }

  #################################################################
  # SERVIR ARCHIVOS DIRECTO DEL VOLUMEN
  #
  # GET /files/... => lee desde /var/joeycare/storage/ecografias/
  #################################################################
  location /files/ {
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    if ($request_method = OPTIONS) { return 204; }

    alias /var/joeycare/storage/ecografias/;
    autoindex off;
    default_type application/octet-stream;
  }

  #################################################################
  # SPA FALLBACK (React Router)
  #################################################################
  location / {
    try_files $uri $uri/ /index.html;
  }

  #################################################################
  # AJUSTES GLOBALES
  #################################################################
  client_max_body_size 200m;
  gzip on;
  gzip_types
    text/plain
    text/css
    application/json
    application/javascript
    application/xml
    application/xml+rss
    image/svg+xml;
}
